# ======================================================================================
# è…³æœ¬åç¨±: å…¨åŠŸèƒ½åª’é«”ä¸‹è¼‰èˆ‡è½‰æ›å·¥å…·
# ç”¨é€”èªªæ˜: ä¸€å€‹å¤šåŠŸèƒ½çš„ Python è…³æœ¬ï¼Œèƒ½å¤ ï¼š
#             1. å¾ YouTube/Bilibili ç­‰ç¶²ç«™ä¸‹è¼‰å½±ç‰‡ (MP4) æˆ–ç´”éŸ³è¨Š (MP3)ã€‚
#             2. å°‡æœ¬åœ°çš„ MP4/MKV/WEBM æª”æ¡ˆè½‰æ›ç‚º MP3ã€‚
#             3. åœ¨èƒŒæ™¯ç›£æ§å‰ªè²¼ç°¿ï¼Œè‡ªå‹•å¿«å–æœ‰æ•ˆé€£çµã€‚
#             4. æä¾›ä¸€å€‹æ°¸è¿œåœ¨çº¿çš„åŠ¨æ€ä»ªè¡¨ç›˜ï¼Œå®æ—¶æ˜¾ç¤ºå’Œå¤„ç†ä»»åŠ¡ã€‚
#             5. é€éè‡ªå‹•å®‰è£ä¾è³´å¥—ä»¶å’Œæª¢æŸ¥ FFmpegï¼Œå¯¦ç¾é–‹ç®±å³ç”¨ã€‚
#
# ç‰ˆæœ¬è™Ÿç³»çµ± (èªæ„åŒ–ç‰ˆæœ¬):
#   - ä¿®è£œ (2.0.Z): ç”¨æ–¼ä¿®å¾©ä¸å½±éŸ¿åŠŸèƒ½çš„ Bugã€‚
#   - æ¬¡è¦ (2.Y.0): ç”¨æ–¼å¢åŠ æ–°åŠŸèƒ½æˆ–é€²è¡Œå„ªåŒ–ï¼Œä¸”å‘ä¸‹ç›¸å®¹ã€‚
#   - ä¸»è¦ (X.0.0): ç”¨æ–¼é€²è¡Œé‡å¤§çš„æ¶æ§‹æ”¹å‹•æˆ–ä¸å‘ä¸‹ç›¸å®¹çš„æ›´æ–°ã€‚
#
# ç‰ˆæœ¬: 2.0.1
#   - [é‡æ§‹] v2.0.1: é€²è¡Œå…¨é¢çš„ç¹é«”ä¸­æ–‡åŒ–ï¼Œæå‡ç¨‹å¼ç¢¼å¯è®€æ€§ã€‚
#   - [ä¿®æ­£] v2.0.1: ä¿®å¾©äº†å›  moviepy åŒ¯å…¥è·¯å¾‘éŒ¯èª¤å°è‡´çš„ ModuleNotFoundError å•Ÿå‹•éŒ¯èª¤ã€‚
#   - [æ¶æ§‹é©å‘½] v2.0.0: é‡æ§‹æˆç‚ºä¸€ä¸ªâ€œæ°¸è¿œåœ¨çº¿â€çš„åŠ¨æ€ä»ªè¡¨ç›˜ã€‚
#
# ä½¿ç”¨å‚™è¨»:
#   - é¦–æ¬¡åŸ·è¡Œå¯èƒ½æœƒæç¤ºå®‰è£å¿…è¦çš„ Python å‡½å¼åº«ã€‚
#   - å¼·çƒˆå»ºè­°å®‰è£ FFmpeg ä¸¦è¨­å®šå¥½ç’°å¢ƒè®Šæ•¸ï¼Œä»¥ç¢ºä¿æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ã€‚
#   - æŒ‰ä¸‹ Enter é”®å¤„ç†å½“å‰åˆ—è¡¨çš„ä»»åŠ¡ã€‚
#   - æŒ‰ä¸‹ Ctrl+C é€€å‡ºç¨‹åºã€‚
# ======================================================================================

import sys
import subprocess
import os
import re
import time
import threading
import shutil
import json
from concurrent.futures import ThreadPoolExecutor

# --- æ­¥é©Ÿ 1: ä¾è³´æª¢æŸ¥èˆ‡è‡ªå‹•å®‰è£ ---
def å®‰è£ä¾è³´å¥—ä»¶(å¥—ä»¶åˆ—è¡¨):
    """æª¢æŸ¥ä¸¦å®‰è£æ‰€æœ‰å¿…è¦çš„å¥—ä»¶ã€‚"""
    ç¼ºå°‘çš„å¥—ä»¶ = []
    for å¥—ä»¶ in å¥—ä»¶åˆ—è¡¨:
        try:
            æ¨¡çµ„åç¨± = å¥—ä»¶.replace('-', '_') if å¥—ä»¶ == 'yt-dlp' else å¥—ä»¶
            __import__(æ¨¡çµ„åç¨±)
        except ImportError:
            ç¼ºå°‘çš„å¥—ä»¶.append(å¥—ä»¶)
    if not ç¼ºå°‘çš„å¥—ä»¶:
        print("æ‰€æœ‰å¿…è¦çš„ä¾è³´å¥—ä»¶å‡å·²å®‰è£ã€‚")
        return True
    print(f"éŒ¯èª¤ï¼šç¼ºå°‘ä»¥ä¸‹å¿…è¦çš„å‡½å¼åº«ï¼š{', '.join(ç¼ºå°‘çš„å¥—ä»¶)}")
    åŒæ„èˆ‡å¦ = input("æ˜¯å¦è¦è®“æœ¬è…³æœ¬è‡ªå‹•ç‚ºæ‚¨å®‰è£ (y/n)ï¼Ÿ ").strip().lower()
    if åŒæ„èˆ‡å¦ == 'y':
        print("\næ­£åœ¨å˜—è©¦è‡ªå‹•å®‰è£ï¼Œè«‹ç¨å€™...")
        try:
            subprocess.check_call([sys.executable, "-m", "pip", "install"] + ç¼ºå°‘çš„å¥—ä»¶)
            print("\n========================================================")
            print("ğŸ‰ ä¾è³´å¥—ä»¶å·²æˆåŠŸå®‰è£ï¼")
            print("ç‚ºäº†è®“æ–°å®‰è£çš„å‡½å¼åº«ç”Ÿæ•ˆï¼Œè«‹é—œé–‰æ­¤è¦–çª—ä¸¦é‡æ–°åŸ·è¡Œä¸€æ¬¡æœ¬è…³æœ¬ã€‚")
            print("========================================================")
        except Exception as e:
            print(f"\nâŒ è‡ªå‹•å®‰è£å¤±æ•—ï¼è«‹æ‰‹å‹•åŸ·è¡Œ 'pip install {' '.join(ç¼ºå°‘çš„å¥—ä»¶)}'ã€‚éŒ¯èª¤è©³æƒ…ï¼š{e}")
        input("\næŒ‰ Enter éµé€€å‡º...")
        sys.exit()
    else:
        print("ä½¿ç”¨è€…å–æ¶ˆå®‰è£ã€‚ç¨‹å¼å³å°‡é€€å‡ºã€‚")
        input("\næŒ‰ Enter éµé€€å‡º...")
        sys.exit()

å¿…éœ€çš„å¥—ä»¶ = ['moviepy', 'yt-dlp', 'pyperclip', 'keyboard']
å®‰è£ä¾è³´å¥—ä»¶(å¿…éœ€çš„å¥—ä»¶)

from moviepy import VideoFileClip
import pyperclip
import keyboard

# --- æ­¥é©Ÿ 2: åŠŸèƒ½å‡½å¼èˆ‡å…¨åŸŸè®Šæ•¸ ---

ä¸‹è¼‰è³‡æ–™å¤¾ = "Downloader_Files"
é€£çµå¿«å– = {}
å¾…è½‰æ›æª”æ¡ˆä½‡åˆ— = set()
åŸ·è¡Œç·’é– = threading.Lock()
ç¨‹å¼æ˜¯å¦åŸ·è¡Œä¸­ = True
ä¸»åŸ·è¡Œç·’æ˜¯å¦å¿™ç¢Œ = threading.Event()

# ã€è¢«éºæ¼çš„å‡½å¼å®šç¾©åœ¨é€™è£¡ã€‘
def æª¢æŸ¥_ffmpeg():
    """å•Ÿå‹•æ™‚æª¢æŸ¥ FFmpeg æ˜¯å¦å­˜åœ¨æ–¼ç³»çµ± PATH ä¸­"""
    if shutil.which("ffmpeg") is None:
        print("\n" + "!"*60)
        print("!ã€é‡è¦æç¤ºã€‘ç³»çµ±æœªæª¢æ¸¬åˆ° FFmpegã€‚è«‹å‹™å¿…å®Œæˆå®‰è£èˆ‡è¨­å®šï¼")
        print("!  - è‹¥å·²è¨­å®šç’°å¢ƒè®Šæ•¸ï¼Œè«‹å˜—è©¦é‡æ–°é–‹æ©Ÿé›»è…¦ã€‚")
        print("!"*60)
        time.sleep(3)

def è¨­å®šä¸‹è¼‰è³‡æ–™å¤¾():
    """ç¢ºä¿ä¸‹è¼‰è³‡æ–™å¤¾å­˜åœ¨ã€‚"""
    if not os.path.exists(ä¸‹è¼‰è³‡æ–™å¤¾):
        os.makedirs(ä¸‹è¼‰è³‡æ–™å¤¾)

def è™•ç†ä¸‹è¼‰ä»»å‹™(é€£çµ, ä¸‹è¼‰é¡å‹='video'):
    print(f"\n[è™•ç†ä»»å‹™] é€£çµ: {é€£çµ} (æ¨¡å¼: {ä¸‹è¼‰é¡å‹.upper()})")
    
    è¼¸å‡ºæ¨¡æ¿ = os.path.join(ä¸‹è¼‰è³‡æ–™å¤¾, '%(title)s.%(ext)s')
    åŸºç¤æŒ‡ä»¤åƒæ•¸ = ['--output', è¼¸å‡ºæ¨¡æ¿]
    
    å½±ç‰‡æ ¼å¼ = 'bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best'
    å½±ç‰‡æŒ‡ä»¤ = ['yt-dlp', '--format', å½±ç‰‡æ ¼å¼, '--merge-output-format', 'mp4'] + åŸºç¤æŒ‡ä»¤åƒæ•¸
    éŸ³è¨ŠæŒ‡ä»¤ = ['yt-dlp', '-x', '--audio-format', 'mp3'] + åŸºç¤æŒ‡ä»¤åƒæ•¸
    å…©è€…éƒ½è¦æŒ‡ä»¤ = ['yt-dlp', '--format', å½±ç‰‡æ ¼å¼, '--merge-output-format', 'mp4', '-k'] + åŸºç¤æŒ‡ä»¤åƒæ•¸

    def åŸ·è¡ŒæŒ‡ä»¤(æŒ‡ä»¤, é€£çµ):
        å®Œæ•´æŒ‡ä»¤ = æŒ‡ä»¤ + [é€£çµ]
        try:
            ç¨‹åº = subprocess.Popen(å®Œæ•´æŒ‡ä»¤, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, universal_newlines=True, encoding='utf-8', errors='replace')
            for è¡Œ in ç¨‹åº.stdout:
                print(è¡Œ, end='')
            ç¨‹åº.wait()
            if ç¨‹åº.returncode != 0:
                raise subprocess.CalledProcessError(ç¨‹åº.returncode, å®Œæ•´æŒ‡ä»¤)
            return True
        except Exception as e:
            print(f"\n--- æŒ‡ä»¤åŸ·è¡Œå¤±æ•—ï¼éŒ¯èª¤ï¼š{e} ---")
            return False

    def åŸ·è¡Œä¸¦æ“·å–è¼¸å‡º(æŒ‡ä»¤, é€£çµ):
        å®Œæ•´æŒ‡ä»¤ = æŒ‡ä»¤ + [é€£çµ]
        try:
            ç¨‹åº = subprocess.Popen(å®Œæ•´æŒ‡ä»¤, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, universal_newlines=True, encoding='utf-8', errors='replace')
            è¼¸å‡ºå…§å®¹ä¸²åˆ— = []
            for è¡Œ in ç¨‹åº.stdout:
                print(è¡Œ, end='')
                è¼¸å‡ºå…§å®¹ä¸²åˆ—.append(è¡Œ)
            ç¨‹åº.wait()
            if ç¨‹åº.returncode != 0:
                raise subprocess.CalledProcessError(ç¨‹åº.returncode, å®Œæ•´æŒ‡ä»¤)
            return "".join(è¼¸å‡ºå…§å®¹ä¸²åˆ—)
        except Exception as e:
            print(f"\n--- æŒ‡ä»¤åŸ·è¡Œå¤±æ•—ï¼éŒ¯èª¤ï¼š{e} ---")
            return None

    if ä¸‹è¼‰é¡å‹ == 'video':
        print("\n--- é–‹å§‹ä¸‹è¼‰ å½±ç‰‡ (MP4) ---")
        åŸ·è¡ŒæŒ‡ä»¤(å½±ç‰‡æŒ‡ä»¤, é€£çµ)
        
    elif ä¸‹è¼‰é¡å‹ == 'audio':
        print("\n--- é–‹å§‹ä¸‹è¼‰ éŸ³è¨Š (MP3) ---")
        åŸ·è¡ŒæŒ‡ä»¤(éŸ³è¨ŠæŒ‡ä»¤, é€£çµ)

    elif ä¸‹è¼‰é¡å‹ == 'both':
        print("\n--- é–‹å§‹ä¸‹è¼‰ å½±ç‰‡ (MP4) + åŸå§‹éŸ³è¨Š ---")
        è¼¸å‡ºå…§å®¹ = åŸ·è¡Œä¸¦æ“·å–è¼¸å‡º(å…©è€…éƒ½è¦æŒ‡ä»¤, é€£çµ)
        if è¼¸å‡ºå…§å®¹:
            éŸ³è¨ŠåŒ¹é…åˆ—è¡¨ = re.findall(r'\[download\] Destination: (.+\.(m4a|webm))', è¼¸å‡ºå…§å®¹)
            if éŸ³è¨ŠåŒ¹é…åˆ—è¡¨:
                åŸå§‹éŸ³è¨Šè·¯å¾‘ = éŸ³è¨ŠåŒ¹é…åˆ—è¡¨[-1][0].strip()
                MP3è·¯å¾‘ = os.path.splitext(åŸå§‹éŸ³è¨Šè·¯å¾‘)[0] + ".mp3"
                print(f"\n--- é–‹å§‹å¾ '{os.path.basename(åŸå§‹éŸ³è¨Šè·¯å¾‘)}' è½‰æ›ç‚º MP3 ---")
                try:
                    subprocess.run(['ffmpeg', '-i', åŸå§‹éŸ³è¨Šè·¯å¾‘, '-codec:a', 'libmp3lame', '-qscale:a', '2', MP3è·¯å¾‘], check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
                    print(f"éŸ³è¨Š '{os.path.basename(MP3è·¯å¾‘)}' è½‰æ›æˆåŠŸï¼")
                    if os.path.exists(åŸå§‹éŸ³è¨Šè·¯å¾‘):
                        os.remove(åŸå§‹éŸ³è¨Šè·¯å¾‘)
                except Exception as e:
                    print(f"å¾åŸå§‹éŸ³è¨Šè½‰æ› MP3 å¤±æ•—ï¼éŒ¯èª¤: {e}")
            else:
                 print("æœªæ‰¾åˆ°åŸå§‹éŸ³è¨Šæµï¼Œå°‡å–®ç¨ä¸‹è¼‰ MP3ã€‚")
                 åŸ·è¡ŒæŒ‡ä»¤(éŸ³è¨ŠæŒ‡ä»¤, é€£çµ)

def å°‡å½±ç‰‡è½‰ç‚ºMP3(æª”æ¡ˆè·¯å¾‘):
    if not (os.path.exists(æª”æ¡ˆè·¯å¾‘) and æª”æ¡ˆè·¯å¾‘.lower().endswith(('.mp4', '.mkv', 'webm'))):
        return
    MP3æª”æ¡ˆè·¯å¾‘ = os.path.splitext(æª”æ¡ˆè·¯å¾‘)[0] + ".mp3"
    print(f"\n[è½‰æ›æ¨¡å¼] æ­£åœ¨è½‰æ›: {os.path.basename(æª”æ¡ˆè·¯å¾‘)}")
    try:
        with VideoFileClip(æª”æ¡ˆè·¯å¾‘) as å½±ç‰‡ç‰‡æ®µ:
            å½±ç‰‡ç‰‡æ®µ.audio.write_audiofile(MP3æª”æ¡ˆè·¯å¾‘, logger=None)
        print(f"è½‰æ›æˆåŠŸï¼ğŸ‰ -> {os.path.basename(MP3æª”æ¡ˆè·¯å¾‘)}")
    except Exception as e:
        print(f"\nè½‰æ›å¤±æ•—ï¼éŒ¯èª¤: {e}")

# --- æ­¥é©Ÿ 3: èƒŒæ™¯å·¥ä½œåŸ·è¡Œç·’ ---

åŸ·è¡Œç·’æ±  = ThreadPoolExecutor(max_workers=4)
ä¸Šæ¬¡å‰ªè²¼ç°¿å…§å®¹ = ""

def æ“·å–æ¨™é¡Œä»»å‹™(é€£çµ):
    try:
        ç¨‹åº = subprocess.run(['yt-dlp', '--dump-json', é€£çµ], capture_output=True, text=True, encoding='utf-8', errors='ignore', check=True, timeout=15)
        è³‡æ–™ = json.loads(ç¨‹åº.stdout)
        æ¨™é¡Œ = è³‡æ–™.get('title', 'ç„¡æ³•æ“·å–æ¨™é¡Œ')
        with åŸ·è¡Œç·’é–:
            é€£çµå¿«å–[é€£çµ] = æ¨™é¡Œ
    except Exception:
        with åŸ·è¡Œç·’é–:
            if é€£çµ in é€£çµå¿«å– and é€£çµå¿«å–[é€£çµ] == "æ­£åœ¨æ“·å–æ¨™é¡Œ...":
                del é€£çµå¿«å–[é€£çµ]

def å‰ªè²¼ç°¿ç›£æ§ä»»å‹™():
    global ä¸Šæ¬¡å‰ªè²¼ç°¿å…§å®¹
    while ç¨‹å¼æ˜¯å¦åŸ·è¡Œä¸­:
        try:
            å‰ªè²¼ç°¿å…§å®¹ = pyperclip.paste()
            if å‰ªè²¼ç°¿å…§å®¹ and å‰ªè²¼ç°¿å…§å®¹ != ä¸Šæ¬¡å‰ªè²¼ç°¿å…§å®¹:
                ä¸Šæ¬¡å‰ªè²¼ç°¿å…§å®¹ = å‰ªè²¼ç°¿å…§å®¹
                if len(å‰ªè²¼ç°¿å…§å®¹) > 5000: continue
                å¯èƒ½çš„é€£çµåˆ—è¡¨ = re.findall(r'https?://[^\s/$.?#].[^\s]*', å‰ªè²¼ç°¿å…§å®¹)
                if not å¯èƒ½çš„é€£çµåˆ—è¡¨: continue
                å¾…æ“·å–çš„å…¨æ–°é€£çµ = []
                with åŸ·è¡Œç·’é–:
                    for é€£çµ in å¯èƒ½çš„é€£çµåˆ—è¡¨:
                        if é€£çµ not in é€£çµå¿«å–:
                            å¾…æ“·å–çš„å…¨æ–°é€£çµ.append(é€£çµ)
                            é€£çµå¿«å–[é€£çµ] = "æ­£åœ¨æ“·å–æ¨™é¡Œ..." 
                for é€£çµ in å¾…æ“·å–çš„å…¨æ–°é€£çµ:
                    åŸ·è¡Œç·’æ± .submit(æ“·å–æ¨™é¡Œä»»å‹™, é€£çµ)
        except pyperclip.PyperclipException:
            pass
        time.sleep(1)

# --- æ­¥é©Ÿ 4: äº’å‹•å¼é¸å–®å‡½å¼ ---

def äº’å‹•å¼å¯©æ ¸é€£çµ():
    global ç¨‹å¼æ˜¯å¦åŸ·è¡Œä¸­
    ä¸»åŸ·è¡Œç·’æ˜¯å¦å¿™ç¢Œ.set()
    try:
        with åŸ·è¡Œç·’é–:
            å¾…å¯©æ ¸çš„é€£çµ = list(é€£çµå¿«å–.items())
        
        os.system('cls' if os.name == 'nt' else 'clear')
        print("--- å¯©æ ¸é€£çµ (é€‰æ‹©è¦è™•ç†çš„) ---")
        if not å¾…å¯©æ ¸çš„é€£çµ:
            print("ä½‡åˆ—ç‚ºç©º...")
            time.sleep(1)
            return

        for ç´¢å¼•, (é€£çµ, æ¨™é¡Œ) in enumerate(å¾…å¯©æ ¸çš„é€£çµ):
            print(f"  [{ç´¢å¼•+1}] {æ¨™é¡Œ}")
        
        ä½¿ç”¨è€…é¸æ“‡ = input(
            "\nè«‹è¼¸å…¥é¸é …ï¼š\n"
            "  - ç·¨è™Ÿ(1, 2, 3) - è™•ç†æŒ‡å®šç·¨è™Ÿçš„é …ç›®\n"
            "  - 'n' - ä¸è™•ç†ä¸¦ç§»é™¤æœ¬æ¬¡é¸å–®ä¸­çš„é …ç›®\n"
            "  - 'c' - æ¸…ç©ºæ‰€æœ‰å¾…è™•ç†é …ç›®\n"
            "  - [Enter] - è™•ç†æœ¬æ¬¡é¸å–®ä¸­çš„æ‰€æœ‰é …ç›®\n"
            "æ‚¨çš„é¸æ“‡ï¼š"
        ).strip().lower()

        if ä½¿ç”¨è€…é¸æ“‡ == '': ä½¿ç”¨è€…é¸æ“‡ = 'all'
        if ä½¿ç”¨è€…é¸æ“‡ == 'n':
            å¾…ç§»é™¤çš„é€£çµ = [é …ç›®[0] for é …ç›® in å¾…å¯©æ ¸çš„é€£çµ]
            with åŸ·è¡Œç·’é–:
                for é€£çµ in å¾…ç§»é™¤çš„é€£çµ:
                    if é€£çµ in é€£çµå¿«å–: del é€£çµå¿«å–[é€£çµ]
            return
        if ä½¿ç”¨è€…é¸æ“‡ == 'c':
            with åŸ·è¡Œç·’é–: é€£çµå¿«å–.clear()
            return
            
        å¾…è™•ç†çš„é€£çµåˆ—è¡¨ = []
        if ä½¿ç”¨è€…é¸æ“‡ == 'all':
            å¾…è™•ç†çš„é€£çµåˆ—è¡¨ = [é …ç›®[0] for é …ç›® in å¾…å¯©æ ¸çš„é€£çµ]
        else:
            try:
                ç´¢å¼•åˆ—è¡¨ = {int(i.strip()) - 1 for i in ä½¿ç”¨è€…é¸æ“‡.split(',')}
                å¾…è™•ç†çš„é€£çµåˆ—è¡¨ = [å¾…å¯©æ ¸çš„é€£çµ[i][0] for i in sorted(list(ç´¢å¼•åˆ—è¡¨)) if 0 <= i < len(å¾…å¯©æ ¸çš„é€£çµ)]
            except ValueError: print("è¼¸å…¥ç„¡æ•ˆï¼"); return
        if not å¾…è™•ç†çš„é€£çµåˆ—è¡¨: return

        os.system('cls' if os.name == 'nt' else 'clear')
        print("--- é¸æ“‡ä¸‹è¼‰å…§å®¹ ---")
        print(" 1. åƒ…å½±ç‰‡ (MP4)")
        print(" 2. åƒ…éŸ³è¨Š (MP3)")
        print(" 3. å…©è€…éƒ½è¦ (æœ€é«˜æ•ˆ)")
        ä¸‹è¼‰é¸æ“‡ = input("è«‹é¸æ“‡ [Enter = 3. å…©è€…éƒ½è¦]ï¼š").strip()
        
        é¡å‹å°æ‡‰ = {'1': 'video', '2': 'audio', '3': 'both'}
        ä¸‹è¼‰é¡å‹ = é¡å‹å°æ‡‰.get(ä¸‹è¼‰é¸æ“‡, 'both')

        os.system('cls' if os.name == 'nt' else 'clear')
        print(f"æº–å‚™è™•ç† {len(å¾…è™•ç†çš„é€£çµåˆ—è¡¨)} å€‹é€£çµï¼Œæ¨¡å¼ç‚ºï¼š{ä¸‹è¼‰é¡å‹.upper()}")
        
        with åŸ·è¡Œç·’é–:
            for é€£çµ in å¾…è™•ç†çš„é€£çµåˆ—è¡¨:
                if é€£çµ in é€£çµå¿«å–: del é€£çµå¿«å–[é€£çµ]
                
        for é€£çµ in å¾…è™•ç†çš„é€£çµåˆ—è¡¨:
            if not ç¨‹å¼æ˜¯å¦åŸ·è¡Œä¸­: break
            è™•ç†ä¸‹è¼‰ä»»å‹™(é€£çµ, ä¸‹è¼‰é¡å‹)
        
        print("\næ‰€æœ‰é¸å®šä»»å‹™å·²å®Œæˆï¼ŒæŒ‰ä»»æ„éµè¿”å›ä¸»ç•«é¢...")
        if os.name == 'nt':
            os.system('pause >nul')
        else:
            input()

    finally:
        ä¸»åŸ·è¡Œç·’æ˜¯å¦å¿™ç¢Œ.clear()

def äº’å‹•å¼å¯©æ ¸æª”æ¡ˆ():
    # TODO: æ­¤åŠŸèƒ½å¾…æœªä¾†ç‰ˆæœ¬å¯¦ç¾
    print("\næª”æ¡ˆè½‰æ›åŠŸèƒ½å¾…å¯¦ç¾...")
    time.sleep(2)
    pass

# --- æ­¥é©Ÿ 5: ä¸»ç¨‹å¼åŸ·è¡Œå€ ---
def ä¸»è¿´åœˆ():
    global ç¨‹å¼æ˜¯å¦åŸ·è¡Œä¸­
    ä¸Šæ¬¡é¡¯ç¤ºçš„ç‹€æ…‹ = None

    while ç¨‹å¼æ˜¯å¦åŸ·è¡Œä¸­:
        try:
            if ä¸»åŸ·è¡Œç·’æ˜¯å¦å¿™ç¢Œ.is_set():
                time.sleep(0.5)
                continue

            with åŸ·è¡Œç·’é–:
                ç›®å‰çš„é€£çµ = list(é€£çµå¿«å–.items())
                ç›®å‰çš„æª”æ¡ˆ = list(å¾…è½‰æ›æª”æ¡ˆä½‡åˆ—)
            
            ç›®å‰ç‹€æ…‹ = (
                tuple(sorted([é …ç›® for é …ç›® in ç›®å‰çš„é€£çµ if é …ç›®[1] != "æ­£åœ¨æ“·å–æ¨™é¡Œ..."])), 
                tuple(sorted(ç›®å‰çš„æª”æ¡ˆ))
            )

            if ç›®å‰ç‹€æ…‹ != ä¸Šæ¬¡é¡¯ç¤ºçš„ç‹€æ…‹:
                os.system('cls' if os.name == 'nt' else 'clear')
                print("="*60)
                print("      å…¨åŠŸèƒ½åª’é«”ä¸‹è¼‰èˆ‡è½‰æ›å·¥å…· (v2.0.1)      ")
                print("      - å‹•æ…‹å„€è¡¨æ¿ (æŒ‰ Enter è™•ç†, Ctrl+C é€€å‡º)      ")
                print("="*60)

                if ç›®å‰çš„é€£çµ:
                    print("\n--- å¾…è™•ç†é€£çµ ---")
                    for ç´¢å¼•, (é€£çµ, æ¨™é¡Œ) in enumerate(ç›®å‰çš„é€£çµ):
                        print(f"  [{ç´¢å¼•+1}] {æ¨™é¡Œ}")
                    print("\n[æç¤º] æ­£åœ¨ç­‰å¾…æ›´å¤šé€£çµ... (æŒ‰ Enter éµç«‹å³è™•ç†ç•¶å‰åˆ—è¡¨)")
                elif ç›®å‰çš„æª”æ¡ˆ:
                    print("\n--- å¾…è½‰æ›æª”æ¡ˆ ---")
                    for ç´¢å¼•, æª”æ¡ˆè·¯å¾‘ in enumerate(ç›®å‰çš„æª”æ¡ˆ):
                         print(f"  [{ç´¢å¼•+1}] {os.path.basename(æª”æ¡ˆè·¯å¾‘)}")
                    print("\n[æç¤º] æŒ‰ Enter éµè™•ç†æª”æ¡ˆè½‰æ›...")
                else:
                    print("\nä½‡åˆ—ç‚ºç©ºï¼Œç­‰å¾…å¾å‰ªè²¼ç°¿è¤‡è£½é€£çµ...")

                ä¸Šæ¬¡é¡¯ç¤ºçš„ç‹€æ…‹ = ç›®å‰ç‹€æ…‹

            if keyboard.is_pressed('enter'):
                if ç›®å‰çš„é€£çµ:
                    äº’å‹•å¼å¯©æ ¸é€£çµ()
                elif ç›®å‰çš„æª”æ¡ˆ:
                    äº’å‹•å¼å¯©æ ¸æª”æ¡ˆ()
                ä¸Šæ¬¡é¡¯ç¤ºçš„ç‹€æ…‹ = None
                time.sleep(0.5)

            time.sleep(0.1)

        except KeyboardInterrupt:
            ç¨‹å¼æ˜¯å¦åŸ·è¡Œä¸­ = False
            break
        except Exception as e:
            os.system('cls' if os.name == 'nt' else 'clear')
            print("\n" + "="*60)
            print("ç™¼ç”Ÿæ„å¤–éŒ¯èª¤ï¼Œè«‹å°‡ä»¥ä¸‹è³‡è¨Šå›å ±çµ¦é–‹ç™¼è€…ï¼š")
            print(str(e))
            print("ç¨‹å¼å°‡åœ¨10ç§’å¾Œè‡ªå‹•é€€å‡º...")
            print("="*60)
            time.sleep(10)
            ç¨‹å¼æ˜¯å¦åŸ·è¡Œä¸­ = False
            break

if __name__ == "__main__":
    æª¢æŸ¥_ffmpeg()
    è¨­å®šä¸‹è¼‰è³‡æ–™å¤¾()

    monitor_thread = threading.Thread(target=å‰ªè²¼ç°¿ç›£æ§ä»»å‹™)
    monitor_thread.daemon = True
    monitor_thread.start()

    ä¸»è¿´åœˆ()

    print("\næ­£åœ¨é—œé–‰åŸ·è¡Œç·’æ± èˆ‡ç¨‹å¼ï¼Œè«‹ç¨å€™...")
    åŸ·è¡Œç·’æ± .shutdown(wait=True)
    print("ç¨‹å¼å·²æˆåŠŸé€€å‡ºã€‚")